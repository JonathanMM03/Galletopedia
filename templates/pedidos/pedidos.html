{% extends "layoutIntranet.html" %}

{% block content %}
<div class="container-fluid px-4">
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-choco text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Pedidos de Galletas</h5>
            <div class="d-flex align-items-center">
                <span class="badge bg-light text-dark me-2">
                    <i class="fas fa-filter me-1"></i> Filtros:
                </span>
                <div class="btn-group">
                    <button type="button" class="btn btn-sm btn-outline-light active" data-filter="todos">Todos</button>
                    <button type="button" class="btn btn-sm btn-outline-light" data-filter="pendientes">Pendientes</button>
                    <button type="button" class="btn btn-sm btn-outline-light" data-filter="entregados">Entregados</button>
                    <button type="button" class="btn btn-sm btn-outline-light" data-filter="cancelados">Cancelados</button>
                </div>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table align-middle m-0" id="tablaPedidos">
                <thead class="bg-choco text-white">
                    <tr>
                        <th>Fecha Pedido</th>
                        <th>Nombre</th>
                        <th>Receta</th>
                        <th>Cantidad</th>
                        <th>Unidad</th>
                        <th>Estado</th>
                        <th>Fecha Entrega</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pedido in pedidos %}
                    <tr class="pedido-row {% if pedido.estado_pedido == 'Cancelado' %}table-danger{% elif pedido.estado_pedido == 'Entregado' %}table-success{% endif %}" 
                        data-estado="{{ pedido.estatus }}">
                        <td>{{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}</td>
                        <td>{{ pedido.nombre_usuario }}</td>
                        <td>{{ pedido.nombre_receta }}</td>
                        <td>{{ pedido.cantidad }}</td>
                        <td>
                            {% if pedido.tipo_venta == 1 %}
                            <span class="badge bg-primary">Pieza</span>
                            {% elif pedido.tipo_venta == 2 %}
                            <span class="badge bg-info">Caja</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pedido.estatus == 'pedido' %}
                            <span class="badge bg-primary">Pedido</span>
                            {% elif pedido.estatus == 'preparacion' %}
                            <span class="badge bg-info">En preparación</span>
                            {% elif pedido.estatus == 'listo' %}
                            <span class="badge bg-success">Listo</span>
                            {% elif pedido.estatus == 'entregado' %}
                            <span class="badge bg-success">Entregado</span>
                            {% elif pedido.estatus == 'cancelado' %}
                            <span class="badge bg-danger">Cancelado</span>
                            {% else %}
                            <span class="badge bg-secondary">{{ pedido.estatus }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pedido.fecha_entrega %}
                            <span class="badge bg-info">{{ pedido.fecha_entrega.strftime('%d/%m/%Y') }}</span>
                            {% else %}
                            <span class="text-muted">Por definir</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if pedido.estatus not in ['entregado', 'cancelado'] %}
                            <div class="d-flex gap-2">
                                <form action="{{ url_for('pedidos.actualizar_pedido') }}" method="POST" class="d-inline flex-grow-1">
                                    {{ form.hidden_tag() }}
                                    <input type="hidden" name="pedido_id" value="{{ pedido.id }}">
                                    <div class="input-group input-group-sm">
                                        {% if pedido.estatus == 'preparacion' %}
                                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="abrirModalFecha({{ pedido.id }})">
                                            <i class="fas fa-box me-1"></i> Preparado
                                        </button>
                                        {% else %}
                                        <button class="btn btn-outline-primary btn-sm" type="submit">
                                            {% if pedido.estatus == 'pedido' %}
                                            <i class="fas fa-check me-1"></i> Atender
                                            {% else %}
                                            <i class="fas fa-truck me-1"></i> Entregar
                                            {% endif %}
                                        </button>
                                        {% endif %}
                                    </div>
                                </form>
                                <button type="button" class="btn btn-outline-danger btn-sm" 
                                        onclick="cancelarPedido({{ pedido.id }})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            {% else %}
                            <span class="badge {% if pedido.estatus == 'entregado' %}bg-success{% else %}bg-danger{% endif %}">
                                {{ pedido.estatus|title }}
                            </span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="8" class="text-center py-4">
                            <div class="text-muted">
                                <i class="fas fa-inbox fa-3x mb-3"></i>
                                <p>No hay ningún pedido realizado.</p>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Controles de Paginación -->
        {% if pagination and pagination.pages > 1 %}
        <div class="card-footer bg-white border-top-0">
            <nav aria-label="Navegación de páginas">
                <ul class="pagination justify-content-center mb-0">
                    <!-- Botón Anterior -->
                    {% if pagination.has_prev %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('pedidos.pedidos', page=pagination.prev_num) }}" aria-label="Anterior">
                            <span aria-hidden="true">&laquo;</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">&laquo;</span>
                    </li>
                    {% endif %}
                    
                    <!-- Números de Página -->
                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                        {% if page_num %}
                            {% if page_num == pagination.page %}
                            <li class="page-item active">
                                <span class="page-link">{{ page_num }}</span>
                            </li>
                            {% else %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('pedidos.pedidos', page=page_num) }}">{{ page_num }}</a>
                            </li>
                            {% endif %}
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- Botón Siguiente -->
                    {% if pagination.has_next %}
                    <li class="page-item">
                        <a class="page-link" href="{{ url_for('pedidos.pedidos', page=pagination.next_num) }}" aria-label="Siguiente">
                            <span aria-hidden="true">&raquo;</span>
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled">
                        <span class="page-link" aria-hidden="true">&raquo;</span>
                    </li>
                    {% endif %}
                </ul>
            </nav>
            <div class="text-center mt-2 text-muted small">
                Mostrando {{ pagination.items|length }} de {{ pagination.total }} pedidos
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modal de Confirmación de Cancelación -->
<div class="modal fade" id="modalCancelar" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Confirmar Cancelación
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">¿Está seguro de que desea cancelar este pedido?</p>
                <p class="text-muted small">Esta acción no se puede deshacer.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i> No
                </button>
                <form id="formCancelar" action="{{ url_for('pedidos.cancelar_pedido') }}" method="POST">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="pedido_id" id="pedidoIdCancelar">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-check me-1"></i> Sí, Cancelar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Fecha de Entrega -->
<div class="modal fade" id="modalFechaEntrega" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-calendar-alt me-2"></i>
                    Asignar Fecha de Entrega
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form action="{{ url_for('pedidos.asignar_fecha_entrega') }}" method="POST">
                <div class="modal-body">
                    {{ form.hidden_tag() }}
                    <input type="hidden" name="pedido_id" id="pedidoIdFecha">
                    <input type="hidden" name="marcar_listo" value="1">
                    <div class="mb-3">
                        <label for="fecha_entrega" class="form-label">Fecha de Entrega</label>
                        <input type="date" class="form-control" id="fecha_entrega" name="fecha_entrega" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i> Cancelar
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i> Confirmar y Marcar como Listo
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function cancelarPedido(pedidoId) {
    document.getElementById('pedidoIdCancelar').value = pedidoId;
    new bootstrap.Modal(document.getElementById('modalCancelar')).show();
}

function abrirModalFecha(pedidoId) {
    document.getElementById('pedidoIdFecha').value = pedidoId;
    new bootstrap.Modal(document.getElementById('modalFechaEntrega')).show();
}

// Filtrado de pedidos
document.addEventListener('DOMContentLoaded', function() {
    const filterButtons = document.querySelectorAll('[data-filter]');
    const rows = document.querySelectorAll('.pedido-row');
    
    filterButtons.forEach(button => {
        button.addEventListener('click', function() {
            const filter = this.getAttribute('data-filter');
            
            // Actualizar botones activos
            filterButtons.forEach(btn => btn.classList.remove('active'));
            this.classList.add('active');
            
            // Filtrar filas
            rows.forEach(row => {
                if (filter === 'todos') {
                    row.style.display = '';
                } else if (filter === 'pendientes') {
                    row.style.display = !['entregado', 'cancelado'].includes(row.getAttribute('data-estado')) ? '' : 'none';
                } else if (filter === 'entregados') {
                    row.style.display = row.getAttribute('data-estado') === 'entregado' ? '' : 'none';
                } else if (filter === 'cancelados') {
                    row.style.display = row.getAttribute('data-estado') === 'cancelado' ? '' : 'none';
                }
            });
        });
    });
});
</script>
{% endblock %}