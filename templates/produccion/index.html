{% extends "layoutIntranet.html" %}

{% block title %}Producción{% endblock %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token() }}">
<style>
    .galleta-card {
        width: 250px;
        min-height: 300px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: space-between;
        background: white;
        padding: 10px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .galleta-card:hover {
        transform: translateY(-5px);
    }
    .warning-icon {
        color: #ffc107;
        font-size: 1.5rem;
    }
    .error-icon {
        color: #dc3545;
        font-size: 1.5rem;
    }
    .galleta-img {
        height: 200px;
        width: 100%;
        object-fit: cover;
        border-radius: 8px;
    }
    .galleta-img-container {
        width: 100%; /* O un tamaño específico */
        height: auto;
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="mb-3">
                <i class="fas fa-cookie-bite text-primary"></i> Producción
            </h2>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#modalIniciarReceta">
                <i class="fas fa-play-circle"></i> Iniciar Receta Manual
            </button>
            <a href="{{ url_for('produccion.registrar_produccion') }}" class="btn btn-primary me-2">
                <i class="fas fa-plus-circle"></i> Registrar Producción
            </a>
            <a href="{{ url_for('produccion.solicitar_insumo') }}" class="btn btn-success">
                <i class="fas fa-shopping-cart"></i> Solicitar Insumos
            </a>
        </div>
    </div>

    <!-- Tarjetas de Galletas -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="fas fa-cookie"></i> Inventario de Galletas
            </h5>
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
                {% for receta in recetas %}
                <div class="col">
                    <div class="card h-100 galleta-card shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 text-truncate" title="{{ receta.nombre }}">{{ receta.nombre }}</h5>
                            <div class="d-flex align-items-center">
                                {% if receta.imagen %}
                                <img src="data:image/jpeg;base64,{{ receta.imagen }}" class="img-fluid rounded me-2" style="max-height: 100px;" alt="{{ receta.nombre }}">
                                {% else %}
                                <div class="d-flex align-items-center justify-content-center me-2" style="max-height: 100px;">
                                    <i class="fas fa-cookie-bite fa-3x text-muted"></i>
                                </div>
                                {% endif %}
                                {% if existencias_galletas[receta.id] <= 50 %}
                                    <i class="fas fa-exclamation-triangle error-icon" title="Stock bajo (50 o menos)"></i>
                                {% elif existencias_galletas[receta.id] <= 100 %}
                                    <i class="fas fa-exclamation-circle warning-icon" title="Stock medio (100 o menos)"></i>
                                {% endif %}
                            </div>
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div>
                                <p class="card-text">
                                    <strong>Stock disponible:</strong> 
                                    <span class="{% if existencias_galletas[receta.id] <= 50 %}text-danger{% elif existencias_galletas[receta.id] <= 100 %}text-warning{% else %}text-success{% endif %}">
                                        {{ existencias_galletas[receta.id] }} galletas
                                    </span>
                                </p>
                                <p class="card-text">
                                    <strong>Precio:</strong> ${{ "%.2f"|format(receta.precio_venta) }}
                                </p>
                                <p class="card-text">
                                    <strong>Gramaje:</strong> {{ receta.gramaje_por_galleta }}g
                                </p>
                            </div>
                            <div class="mt-auto">
                                <button type="button" class="btn btn-sm btn-primary w-100" onclick="abrirModalIniciarReceta({{ receta.id }}, '{{ receta.nombre }}')">
                                    <i class="fas fa-plus-circle"></i> Producir
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Pedidos en Proceso -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">
                <i class="fas fa-cogs"></i> Pedidos en Proceso
            </h5>
        </div>
        <div class="card-body">
            {% if pedidos_en_proceso %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_en_proceso %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge bg-info">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded" style="max-height: 100px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-success btn-sm" 
                                        onclick="actualizarEstado({{ pedido.id }}, 4)">
                                    <i class="fas fa-check-circle"></i> Completar
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" 
                                        onclick="actualizarEstado({{ pedido.id }}, 5)">
                                    <i class="fas fa-times-circle"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No hay pedidos en proceso.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pedidos Pendientes -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-warning text-white">
            <h5 class="mb-0">
                <i class="fas fa-clock"></i> Pedidos Pendientes
            </h5>
        </div>
        <div class="card-body">
            {% if pedidos_pendientes %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_pendientes %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge bg-warning">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded" style="max-height: 100px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-success btn-sm" 
                                        onclick="actualizarEstado({{ pedido.id }}, 3)">
                                    <i class="fas fa-play"></i> Iniciar Producción
                                </button>
                                <button type="button" class="btn btn-danger btn-sm" 
                                        onclick="actualizarEstado({{ pedido.id }}, 5)">
                                    <i class="fas fa-times-circle"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No hay pedidos pendientes.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pedidos Completados -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0">
                <i class="fas fa-check-circle"></i> Pedidos Completados
            </h5>
        </div>
        <div class="card-body">
            {% if pedidos_completados %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_completados %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge bg-success">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded" style="max-height: 100px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}<br>
                                <strong>Fecha de Completado:</strong> {{ pedido.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') if pedido.fecha_actualizacion else 'N/A' }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No hay pedidos completados.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Pedidos Cancelados -->
    <div class="card shadow-sm">
        <div class="card-header bg-danger text-white">
            <h5 class="mb-0">
                <i class="fas fa-ban"></i> Pedidos Cancelados
            </h5>
        </div>
        <div class="card-body">
            {% if pedidos_cancelados %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_cancelados %}
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge bg-danger">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded" style="max-height: 100px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}<br>
                                <strong>Fecha de Cancelación:</strong> {{ pedido.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') if pedido.fecha_actualizacion else 'N/A' }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> No hay pedidos cancelados.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal para solicitar insumos -->
<div class="modal fade" id="modalSolicitarInsumos" tabindex="-1" aria-labelledby="modalSolicitarInsumosLabel">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalSolicitarInsumosLabel">Solicitar Insumos Faltantes</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <div id="insumosFaltantesLista" role="list" aria-label="Lista de insumos faltantes">
                    <!-- Aquí se mostrarán los insumos faltantes -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="btnSolicitarInsumos">Solicitar Insumos</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para iniciar receta manual -->
<div class="modal fade" id="modalIniciarReceta" tabindex="-1" aria-labelledby="modalIniciarRecetaLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalIniciarRecetaLabel">Iniciar Receta Manual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
                <form id="formIniciarReceta">
                    <div class="mb-3">
                        <label for="receta_id" class="form-label">Receta</label>
                        <select class="form-select" id="receta_id" name="receta_id" required onchange="previsualizarProduccion()">
                            <option value="">Seleccione una receta</option>
                            {% for receta in recetas %}
                            <option value="{{ receta.id }}">{{ receta.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidad" class="form-label">Cantidad de Galletas</label>
                        <input type="number" class="form-control" id="cantidad" name="cantidad" min="1" required onchange="previsualizarProduccion()">
                    </div>
                </form>

                <!-- Sección de previsualización -->
                <div id="previsualizacionContainer" style="display: none;">
                    <hr>
                    <h6 class="mb-3">Previsualización de Producción</h6>
                    <div id="previsualizacionContent">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Seleccione una receta y cantidad para ver la previsualización
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="iniciarProduccion()" id="btnIniciarReceta" disabled>Iniciar Producción</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Inicializar la variable recetas con los datos disponibles
    const recetas = [
        {% for receta in recetas %}
        {
            id: {{ receta.id }},
            nombre: "{{ receta.nombre }}",
            galletas_por_lote: {{ receta.galletas_por_lote }},
            gramaje_por_galleta: {{ receta.gramaje_por_galleta }},
            precio_venta: {{ receta.precio_venta }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    function abrirModalIniciarReceta(recetaId, recetaNombre) {
        // Seleccionar la receta en el modal
        const selectReceta = document.getElementById('receta_id');
        if (selectReceta) {
            selectReceta.value = recetaId;
        }
        
        // Precargar la cantidad de galletas por lote
        const inputCantidad = document.getElementById('cantidad');
        if (inputCantidad) {
            // Buscar la receta seleccionada en el array de recetas
            const recetaSeleccionada = recetas.find(r => r.id === recetaId);
            if (recetaSeleccionada && recetaSeleccionada.galletas_por_lote) {
                inputCantidad.value = recetaSeleccionada.galletas_por_lote;
            }
        }
        
        // Mostrar el modal
        const modalIniciarReceta = new bootstrap.Modal(document.getElementById('modalIniciarReceta'));
        modalIniciarReceta.show();
        
        // Actualizar la previsualización después de un breve retraso
        setTimeout(() => {
            // Verificar que el valor de cantidad no se haya perdido
            const inputCantidad = document.getElementById('cantidad');
            const recetaSeleccionada = recetas.find(r => r.id === recetaId);
            
            if (inputCantidad && recetaSeleccionada && recetaSeleccionada.galletas_por_lote) {
                // Si el valor se perdió, restaurarlo
                if (!inputCantidad.value || inputCantidad.value === '') {
                    inputCantidad.value = recetaSeleccionada.galletas_por_lote;
                }
            }
            
            // Llamar a la función de previsualización
            previsualizarProduccion();
        }, 500);
    }

    async function confirmarCancelacion(pedidoId) {
        try {
            const result = await Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Deseas cancelar este pedido?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cancelar',
                cancelButtonText: 'No, mantener'
            });

            if (result.isConfirmed) {
                // Mostrar indicador de carga
                Swal.fire({
                    title: 'Procesando...',
                    text: 'Por favor espere',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(`/produccion/cancelar_pedido/${pedidoId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cancelar el pedido');
                }

                // Mostrar mensaje de éxito
                await Swal.fire({
                    title: '¡Éxito!',
                    text: data.message,
                    icon: 'success'
                });

                // Recargar la página
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            await Swal.fire({
                title: 'Error',
                text: error.message || 'Ocurrió un error al cancelar el pedido',
                icon: 'error'
            });
        }
    }

    function producirLote(recetaId, pedidoId, galletasPorLote) {
        // Verificar que tenemos los datos necesarios
        if (!recetaId || !pedidoId || !galletasPorLote) {
            Swal.fire({
                title: 'Error',
                text: 'Datos incompletos para producir el lote',
                icon: 'error'
            });
            return;
        }
        
        Swal.fire({
            title: '¿Producir lote?',
            text: `Se producirán ${galletasPorLote} galletas (1 lote)`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, producir',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('receta_id', recetaId);
                formData.append('pedido_id', pedidoId);
                formData.append('cantidad', galletasPorLote);

                // Mostrar indicador de carga
                Swal.fire({
                    title: 'Procesando producción',
                    text: 'Por favor espere...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Enviar la solicitud
                fetch('/produccion/producir', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    return response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.error || 'Error al procesar la producción');
                        }
                        return data;
                    });
                })
                .then(data => {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: data.message,
                        icon: 'success'
                    }).then(() => {
                        window.location.reload();
                    });
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: error.message || 'Ocurrió un error al procesar la solicitud',
                        icon: 'error'
                    });
                });
            }
        });
    }

    function solicitarInsumosFaltantes(recetaId, pedidoId) {
        // Obtener información de insumos faltantes
        fetch(`/produccion/insumos_faltantes/${recetaId}/${pedidoId}`)
            .then(response => response.json())
            .then(data => {
                // Mostrar lista de insumos faltantes
                const listaInsumos = document.getElementById('insumosFaltantesLista');
                listaInsumos.innerHTML = '';
                
                data.insumos_faltantes.forEach(insumo => {
                    const item = document.createElement('div');
                    item.className = 'alert alert-warning';
                    item.setAttribute('role', 'listitem');
                    item.innerHTML = `
                        <strong>${insumo.nombre}</strong><br>
                        Cantidad necesaria: ${insumo.cantidad_necesaria} ${insumo.unidad}<br>
                        Cantidad disponible: ${insumo.cantidad_disponible} ${insumo.unidad}
                    `;
                    listaInsumos.appendChild(item);
                });
                
                // Configurar botón para solicitar insumos
                const btnSolicitar = document.getElementById('btnSolicitarInsumos');
                btnSolicitar.onclick = function() {
                    solicitarInsumos(recetaId, pedidoId, data.insumos_faltantes);
                };
                
                // Mostrar modal
                const modalElement = document.getElementById('modalSolicitarInsumos');
                const modal = new bootstrap.Modal(modalElement);
                
                // Manejar el foco cuando se muestra el modal
                modalElement.addEventListener('shown.bs.modal', function () {
                    const closeButton = modalElement.querySelector('.btn-close');
                    if (closeButton) {
                        closeButton.focus();
                    }
                });
                
                // Manejar el foco cuando se oculta el modal
                modalElement.addEventListener('hidden.bs.modal', function () {
                    // Devolver el foco al botón que abrió el modal
                    const triggerButton = document.querySelector(`[onclick*="solicitarInsumosFaltantes(${recetaId}, ${pedidoId})"]`);
                    if (triggerButton) {
                        triggerButton.focus();
                    }
                });
                
                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Ocurrió un error al obtener los insumos faltantes',
                    icon: 'error'
                });
            });
    }

    function solicitarInsumos(recetaId, pedidoId, insumosFaltantes) {
        if (!recetaId || !pedidoId || !insumosFaltantes || insumosFaltantes.length === 0) {
            Swal.fire({
                title: 'Error',
                text: 'No hay insumos para solicitar',
                icon: 'error'
            });
            return;
        }
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Procesando solicitud',
            text: 'Por favor espere...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Crear objeto de datos para enviar
        const formData = new FormData();
        formData.append('receta_id', recetaId);
        formData.append('pedido_id', pedidoId);
        
        // Agregar cada insumo faltante al formulario
        insumosFaltantes.forEach((insumo, index) => {
            formData.append(`insumo_id_${index}`, insumo.id);
            formData.append(`cantidad_${index}`, insumo.cantidad_necesaria);
        });
        
        // Enviar la solicitud
        fetch('/produccion/solicitar_insumos', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        })
        .then(response => {
            // Verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                return response.json();
            } else {
                throw new Error('La respuesta del servidor no es JSON válido');
            }
        })
        .then(data => {
            if (data.error) {
                throw new Error(data.error);
            }
            
            Swal.fire({
                title: '¡Éxito!',
                text: data.message,
                icon: 'success'
            }).then(() => {
                location.reload();
            });
        })
        .catch(error => {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: error.message || 'Ocurrió un error al procesar la solicitud',
                icon: 'error'
            });
        });
    }

    // Función para verificar insumos
    async function verificarInsumos(recetaId, cantidad) {
        try {
            const response = await fetch('/produccion/verificar_insumos_receta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({
                    receta_id: recetaId,
                    cantidad: cantidad
                })
            });

            const data = await response.json();
            
            // Imprimir en consola los datos recibidos
            console.log('=== Datos recibidos del backend ===');
            console.log('Insumos disponibles:', data.insumos_disponibles);
            console.log('Insumos necesarios:', data.insumos_necesarios);
            console.log('Cantidad de galletas:', data.cantidad_galletas);
            console.log('Receta:', data.receta);
            console.log('==================================');

            return data;
        } catch (error) {
            console.error('Error al verificar insumos:', error);
            throw error;
        }
    }

    function atenderPedido(pedidoId) {
        // Obtener el ID de la receta del pedido
        const recetaId = document.querySelector(`[data-pedido-id="${pedidoId}"]`).dataset.recetaId;
        
        // Primero verificar si se puede atender
        fetch(`/produccion/verificar_receta/${recetaId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Respuesta de verificación:', data); // Para debug
                
                if (data.success) {
                    // Mostrar modal para ingresar merma
                    Swal.fire({
                        title: 'Registrar Producción',
                        html: `
                            <div class="mb-3">
                                <label for="merma" class="form-label">Cantidad de Merma</label>
                                <input type="number" class="form-control" id="merma" min="0" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="motivo_merma" class="form-label">Motivo de la Merma</label>
                                <textarea class="form-control" id="motivo_merma" rows="2"></textarea>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Confirmar',
                        cancelButtonText: 'Cancelar',
                        preConfirm: () => {
                            return {
                                merma: document.getElementById('merma').value,
                                motivo_merma: document.getElementById('motivo_merma').value
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const formData = new FormData();
                            formData.append('pedido_id', pedidoId);
                            formData.append('accion', 'atender');
                            formData.append('merma', result.value.merma);
                            formData.append('motivo_merma', result.value.motivo_merma);
                            
                            fetch('/inventario/atender', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token() }}'
                                }
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Éxito',
                                        text: data.message,
                                        confirmButtonText: 'Aceptar'
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: data.message
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'Ocurrió un error al procesar el pedido'
                                });
                            });
                        }
                    });
                } else {
                    let mensaje = 'No hay suficientes insumos para atender este pedido.';
                    if (data.insumos_faltantes && data.insumos_faltantes.length > 0) {
                        mensaje += '\nInsumos faltantes:';
                        data.insumos_faltantes.forEach(insumo => {
                            mensaje += `\n- ${insumo.nombre}: ${insumo.cantidad_faltante} ${insumo.unidad}`;
                        });
                    }
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: mensaje
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al verificar los insumos'
                });
            });
    }

    function actualizarEstado(pedidoId, nuevoEstado) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
        
        // Si el nuevo estado es completado (4), mostrar modal de merma
        if (nuevoEstado === 4) {
            Swal.fire({
                title: 'Registrar Merma',
                html: `
                    <div class="mb-3">
                        <label for="merma" class="form-label">Cantidad de Merma</label>
                        <input type="number" class="form-control" id="merma" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="motivo_merma" class="form-label">Motivo de la Merma</label>
                        <textarea class="form-control" id="motivo_merma" rows="2"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    return {
                        merma: document.getElementById('merma').value,
                        motivo_merma: document.getElementById('motivo_merma').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Mostrar indicador de carga
                    Swal.fire({
                        title: 'Procesando...',
                        text: 'Por favor espere',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        willOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Crear FormData con todos los datos necesarios
                    const formData = new FormData();
                    formData.append('estado_pedido_id', nuevoEstado);
                    formData.append('merma', result.value.merma);
                    formData.append('motivo_merma', result.value.motivo_merma);

                    // Enviar la solicitud
                    fetch(`/produccion/actualizar_estado/${pedidoId}`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            Swal.fire({
                                title: '¡Éxito!',
                                text: data.message,
                                icon: 'success'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            throw new Error(data.message);
                        }
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Error',
                            text: error.message || 'Ocurrió un error al actualizar el estado',
                            icon: 'error'
                        });
                    });
                }
            });
        } else {
            // Para otros estados, proceder normalmente
            const formData = new FormData();
            formData.append('estado_pedido_id', nuevoEstado);

            // Mostrar indicador de carga
            Swal.fire({
                title: 'Procesando...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`/produccion/actualizar_estado/${pedidoId}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: data.message,
                        icon: 'success'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    throw new Error(data.message);
                }
            })
            .catch(error => {
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Ocurrió un error al actualizar el estado',
                    icon: 'error'
                });
            });
        }
    }

    // Función para previsualizar la producción
    async function previsualizarProduccion() {
        const recetaId = document.getElementById('receta_id').value;
        const cantidad = document.getElementById('cantidad').value;
        
        if (!recetaId || !cantidad) {
            // Si no hay receta o cantidad, mostrar mensaje en el contenedor de previsualización
            const previsualizacionDiv = document.getElementById('previsualizacionContainer');
            const previsualizacionContent = document.getElementById('previsualizacionContent');
            
            if (previsualizacionDiv && previsualizacionContent) {
                previsualizacionDiv.style.display = 'block';
                previsualizacionContent.innerHTML = '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle"></i> Por favor seleccione una receta y especifique la cantidad</div>';
            }
            return;
        }
        
        try {
            // Mostrar indicador de carga
            const previsualizacionDiv = document.getElementById('previsualizacionContainer');
            const previsualizacionContent = document.getElementById('previsualizacionContent');
            
            if (previsualizacionDiv && previsualizacionContent) {
                previsualizacionDiv.style.display = 'block';
                previsualizacionContent.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Cargando...</span></div></div>';
            }
            
            const response = await fetch(`/produccion/previsualizarProduccion/${recetaId}/${cantidad}`);
            
            // Verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('La respuesta del servidor no es JSON válido');
            }
            
            const data = await response.json();
            
            if (data.success) {
                // Usar los elementos existentes en lugar de crear nuevos
                if (previsualizacionDiv && previsualizacionContent) {
                    let html = `
                        <div class="alert alert-info">
                            <h4>Previsualización de Producción</h4>
                            <p><strong>Receta:</strong> ${data.receta.nombre}</p>
                            <p><strong>Cantidad solicitada:</strong> ${data.cantidad_solicitada} galletas</p>
                            <p><strong>Cantidad ajustada:</strong> ${data.cantidad_ajustada} galletas</p>
                            <p><strong>Estado de Insumos:</strong> ${data.hay_suficientes_insumos ? 'Hay suficientes insumos disponibles' : 'No hay suficientes insumos disponibles'}</p>
                        </div>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Insumo</th>
                                    <th>Tipo</th>
                                    <th>Necesario</th>
                                    <th>Disponible</th>
                                    <th>Lotes</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    data.insumos.forEach(insumo => {
                        html += `
                            <tr class="${insumo.hay_suficientes ? '' : 'table-danger'}">
                                <td>${insumo.nombre}</td>
                                <td>${insumo.tipo}</td>
                                <td>${insumo.cantidad_necesaria} ${insumo.unidad}</td>
                                <td>${insumo.cantidad_disponible} ${insumo.unidad}</td>
                                <td>${insumo.lotes_info}</td>
                            </tr>
                        `;
                    });
                    
                    html += `
                            </tbody>
                        </table>
                    `;
                    
                    previsualizacionContent.innerHTML = html;
                    window.produccionData = data;
                    
                    // Habilitar el botón de iniciar receta
                    const btnIniciarReceta = document.getElementById('btnIniciarReceta');
                    if (btnIniciarReceta) {
                        btnIniciarReceta.disabled = !data.hay_suficientes_insumos;
                    }
                } else {
                    console.error('No se encontraron los elementos de previsualización');
                    alert('Error: No se encontraron los elementos de previsualización');
                }
            } else {
                if (previsualizacionContent) {
                    previsualizacionContent.innerHTML = `<div class="alert alert-danger">${data.message || 'Error al previsualizar la producción'}</div>`;
                } else {
                    alert(data.message || 'Error al previsualizar la producción');
                }
            }
        } catch (error) {
            console.error('Error:', error);
            
            // Mostrar el error en la interfaz si es posible
            const previsualizacionContent = document.getElementById('previsualizacionContent');
            if (previsualizacionContent) {
                previsualizacionContent.innerHTML = `<div class="alert alert-danger">Error al previsualizar la producción: ${error.message}</div>`;
            } else {
                alert(`Error al previsualizar la producción: ${error.message}`);
            }
        }
    }
    
    // Función para iniciar la producción
    async function iniciarProduccion() {
        if (!window.produccionData) {
            alert('No hay datos de producción disponibles');
            return;
        }
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Procesando...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });
        
        const data = {
            receta_id: window.produccionData.receta.id,
            cantidad: window.produccionData.cantidad_solicitada,
            insumos: window.produccionData.insumos.map(insumo => {
                const lotesInfo = insumo.lotes_info;
                const lotesSeleccionados = [];
                
                if (lotesInfo && lotesInfo !== 'Sin lotes disponibles') {
                    const lotes = lotesInfo.split(', ');
                    let cantidadRestante = insumo.cantidad_necesaria;
                    
                    lotes.forEach(loteInfo => {
                        const match = loteInfo.match(/L(\d+)\((\d+)\)/);
                        if (match) {
                            const loteId = `L${match[1]}`;
                            const cantidadDisponible = parseInt(match[2]);
                            
                            if (cantidadRestante > 0) {
                                const cantidadAUsar = Math.min(cantidadDisponible, cantidadRestante);
                                lotesSeleccionados.push({
                                    lote_id: loteId,
                                    cantidad_a_usar: cantidadAUsar
                                });
                                cantidadRestante -= cantidadAUsar;
                            }
                        }
                    });
                }
                
                return {
                    nombre: insumo.nombre,
                    cantidad_necesaria: insumo.cantidad_necesaria,
                    lotes_seleccionados: lotesSeleccionados
                };
            })
        };
        
        try {
            // Obtener el token CSRF
            const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
            
            const response = await fetch('/produccion/empezar_receta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(data)
            });
            
            // Verificar si la respuesta es JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                throw new Error('La respuesta del servidor no es JSON válido');
            }
            
            const result = await response.json();
            
            if (result.success) {
                Swal.fire({
                    title: '¡Éxito!',
                    text: `Producción iniciada correctamente. Pedido ID: ${result.pedido_id}`,
                    icon: 'success'
                }).then(() => {
                    window.location.reload();
                });
            } else {
                throw new Error(result.message || 'Error al iniciar la producción');
            }
        } catch (error) {
            console.error('Error:', error);
            Swal.fire({
                title: 'Error',
                text: error.message || 'Error al iniciar la producción',
                icon: 'error'
            });
        }
    }

    function iniciarRecetaManual() {
        const recetaId = document.getElementById('receta_id').value;
        const cantidad = document.getElementById('cantidad').value;
        
        if (!recetaId || !cantidad) {
            Swal.fire({
                title: 'Error',
                text: 'Por favor seleccione una receta y especifique la cantidad',
                icon: 'error'
            });
            return;
        }
        
        // Primero obtener la previsualización para verificar insumos
        fetch(`/produccion/previsualizarProduccion/${recetaId}/${cantidad}`)
            .then(response => {
                // Verificar si la respuesta es JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    throw new Error('La respuesta del servidor no es JSON válido');
                }
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Error al previsualizar la producción');
                }
                
                // Verificar si hay suficientes insumos
                if (!data.hay_suficientes_insumos) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay suficientes insumos para producir esta cantidad de galletas',
                        icon: 'error'
                    });
                    return;
                }
                
                // Confirmar antes de iniciar
                return Swal.fire({
                    title: '¿Iniciar producción?',
                    text: `Se iniciará la producción de ${data.cantidad_ajustada} galletas con la receta ${data.receta.nombre}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, iniciar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        return data; // Devolver los datos de previsualización
                    } else {
                        throw new Error('Operación cancelada por el usuario');
                    }
                });
            })
            .then(data => {
                // Mostrar indicador de carga
                Swal.fire({
                    title: 'Procesando...',
                    text: 'Por favor espere',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });
                
                // Preparar los datos para enviar
                const requestData = {
                    receta_id: data.receta.id,
                    cantidad: data.cantidad_solicitada,
                    insumos: data.insumos.map(insumo => {
                        const lotesInfo = insumo.lotes_info;
                        const lotesSeleccionados = [];
                        
                        if (lotesInfo && lotesInfo !== 'Sin lotes disponibles') {
                            const lotes = lotesInfo.split(', ');
                            let cantidadRestante = insumo.cantidad_necesaria;
                            
                            lotes.forEach(loteInfo => {
                                const match = loteInfo.match(/L(\d+)\((\d+)\)/);
                                if (match) {
                                    const loteId = `L${match[1]}`;
                                    const cantidadDisponible = parseInt(match[2]);
                                    
                                    if (cantidadRestante > 0) {
                                        const cantidadAUsar = Math.min(cantidadDisponible, cantidadRestante);
                                        lotesSeleccionados.push({
                                            lote_id: loteId,
                                            cantidad_a_usar: cantidadAUsar
                                        });
                                        cantidadRestante -= cantidadAUsar;
                                    }
                                }
                            });
                        }
                        
                        return {
                            nombre: insumo.nombre,
                            cantidad_necesaria: insumo.cantidad_necesaria,
                            lotes_seleccionados: lotesSeleccionados
                        };
                    })
                };
                
                // Obtener el token CSRF
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;
                
                // Enviar la solicitud a /produccion/empezar_receta
                return fetch('/produccion/empezar_receta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(requestData)
                }).then(response => {
                    // Verificar si la respuesta es JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        throw new Error('La respuesta del servidor no es JSON válido');
                    }
                });
            })
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: `Producción iniciada correctamente. Pedido ID: ${data.pedido_id}`,
                        icon: 'success'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    throw new Error(data.message || 'Error al iniciar la producción');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Ocurrió un error al iniciar la producción',
                    icon: 'error'
                });
            });
    }
</script>
{% endblock %} 