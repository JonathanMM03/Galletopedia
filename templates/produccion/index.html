{% extends "layoutIntranet.html" %}

{% block title %}Producción{% endblock %}

{% block head %}
{{ super() }}
<meta name="csrf-token" content="{{ csrf_token() }}">

{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- EJEMPLO DE USO DE BOTONES -->
    <div class="row mb-4">
        <div class="col-md-6">
            <h2 class="mb-3" style="color: var(--color-marron-oscuro);">
                <i class="bi bi-cookie"></i> Producción
            </h2>
        </div>
        <div class="col-md-6 text-end">
            <button type="button" class="btn btn-primary me-2" data-bs-toggle="modal"
                data-bs-target="#modalIniciarReceta">
                <i class="bi bi-play-circle"></i> Iniciar Receta
            </button>
            <a href="{{ url_for('produccion.registrar_produccion') }}" class="btn btn-primary me-2">
                <i class="fas fa-plus-circle"></i> Registrar Producción
            </a>
            <a href="{{ url_for('produccion.solicitar_insumo') }}" class="btn btn-success">
                <i class="fas fa-shopping-cart"></i> Solicitar Insumos
            </a>
        </div>
    </div>

    <!-- INVENTARIO DE GALLETAS -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="section-header">
            <h5 class="mb-0"><i class="bi bi-cookie"></i> Inventario de Galletas</h5>
        </div>
        <div class="card-body">
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
                {% for receta in recetas %}
                <div class="col">
                    <div class="galleta-card h-100">
                        <div class="card-header">
                            <h5 class="mb-0 text-truncate" title="{{ receta.nombre }}">
                                <i class="bi bi-egg-fried"></i> {{ receta.nombre }}
                            </h5>
                        </div>
                        <div class="card-body">
                            {% if receta.imagen %}
                            <div class="text-center mb-3">
                                <img src="data:image/jpeg;base64,{{ receta.imagen }}" class="img-fluid rounded"
                                    style="max-height: 120px;" alt="{{ receta.nombre }}">
                            </div>
                            {% else %}
                            <div class="text-center mb-3"
                                style="height: 120px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-cookie" style="font-size: 3rem; color: var(--color-marron);"></i>
                            </div>
                            {% endif %}

                            <p class="mb-2">
                                <strong>Stock:</strong>
                                <span
                                    class="{% if existencias_galletas[receta.id] <= 50 %}stock-bajo{% elif existencias_galletas[receta.id] <= 100 %}stock-medio{% else %}stock-ok{% endif %}">
                                    {{ existencias_galletas[receta.id] }} unidades
                                </span>
                                {% if existencias_galletas[receta.id] <= 50 %} <i
                                    class="bi bi-exclamation-triangle-fill float-end"
                                    style="color: var(--color-marron-oscuro);"></i>
                                    {% elif existencias_galletas[receta.id] <= 100 %} <i
                                        class="bi bi-exclamation-circle-fill float-end"
                                        style="color: var(--color-marron);"></i>
                                        {% endif %}
                            </p>

                            <p class="mb-2"><strong>Precio:</strong> ${{ "%.2f"|format(receta.precio_venta) }}</p>
                            <p class="mb-0"><strong>Gramaje:</strong> {{ receta.gramaje_por_galleta }}g</p>
                        </div>
                        <div class="card-footer text-center">
                            <button type="button" class="btn btn-primary w-100"
                                onclick="abrirModalIniciarReceta({{ receta.id }}, '{{ receta.nombre }}')">
                                <i class="bi bi-plus-circle"></i> Producir
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- PEDIDOS EN PROCESO -->
    <div class="card mb-4 border-0 shadow-sm proceso">
        <div class="section-header">
            <h5 class="mb-0"><i class="bi bi-gear"></i> Pedidos en Proceso</h5>
        </div>
        <div class="card-body">
            {% if pedidos_en_proceso %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_en_proceso %}
                <div class="col">
                    <div class="galleta-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded"
                                style="max-height: 50px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-success btn-sm"
                                    onclick="actualizarEstado({{ pedido.id }}, 4)">
                                    <i class="bi bi-check-circle"></i> Completar
                                </button>
                                <button type="button" class="btn btn-danger btn-sm"
                                    onclick="actualizarEstado({{ pedido.id }}, 5)">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay pedidos en proceso actualmente.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- PEDIDOS PENDIENTES -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="section-header">
            <h5 class="mb-0"><i class="bi bi-clock"></i> Pedidos Pendientes</h5>
        </div>
        <div class="card-body">
            {% if pedidos_pendientes %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_pendientes %}
                <div class="col">
                    <div class="galleta-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded"
                                style="max-height: 50px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}
                            </p>
                        </div>
                        <div class="card-footer">
                            <div class="d-flex justify-content-between">
                                <button type="button" class="btn btn-success btn-sm"
                                    onclick="actualizarEstado({{ pedido.id }}, 3)">
                                    <i class="bi bi-play"></i> Iniciar Producción
                                </button>
                                <button type="button" class="btn btn-danger btn-sm"
                                    onclick="actualizarEstado({{ pedido.id }}, 5)">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay pedidos pendientes actualmente.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- PEDIDOS COMPLETADOS -->
    <div class="card mb-4 border-0 shadow-sm completado">
        <div class="section-header">
            <h5 class="mb-0"><i class="bi bi-check-circle"></i> Pedidos Completados</h5>
        </div>
        <div class="card-body">
            {% if pedidos_completados %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_completados %}
                <div class="col">
                    <div class="galleta-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded"
                                style="max-height: 50px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}<br>
                                <strong>Completado:</strong> {{ pedido.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') if
                                pedido.fecha_actualizacion else 'N/A' }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay pedidos completados recientemente.
            </div>
            {% endif %}
        </div>
    </div>

    <!-- PEDIDOS CANCELADOS -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="section-header" style="background-color: var(--color-marron-oscuro);">
            <h5 class="mb-0"><i class="bi bi-ban"></i> Pedidos Cancelados</h5>
        </div>
        <div class="card-body">
            {% if pedidos_cancelados %}
            <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                {% for pedido in pedidos_cancelados %}
                <div class="col">
                    <div class="galleta-card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <span class="badge">Pedido #{{ pedido.id }}</span>
                            {% if pedido.receta.imagen %}
                            <img src="data:image/jpeg;base64,{{ pedido.receta.imagen }}" class="img-fluid rounded"
                                style="max-height: 50px;">
                            {% endif %}
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ pedido.receta.nombre }}</h5>
                            <p class="card-text">
                                <strong>Cantidad:</strong> {{ pedido.cantidad }} galletas<br>
                                <strong>Estado:</strong> {{ pedido.estado_pedido.nombre }}<br>
                                <strong>Fecha:</strong> {{ pedido.fecha_pedido.strftime('%d/%m/%Y %H:%M') }}<br>
                                <strong>Cancelado:</strong> {{ pedido.fecha_actualizacion.strftime('%d/%m/%Y %H:%M') if
                                pedido.fecha_actualizacion else 'N/A' }}
                            </p>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="alert alert-info text-center">
                <i class="bi bi-info-circle"></i> No hay pedidos cancelados recientemente.
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- MODAL INICIAR RECETA -->
<div class="modal fade" id="modalIniciarReceta" tabindex="-1" aria-labelledby="modalIniciarRecetaLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalIniciarRecetaLabel"><i class="bi bi-play-circle"></i> Iniciar Receta
                    Manual</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="formIniciarReceta">
                    <div class="mb-3">
                        <label for="receta_id" class="form-label">Receta</label>
                        <select class="form-select" id="receta_id" name="receta_id" required>
                            <option value="">Seleccione una receta</option>
                            {% for receta in recetas %}
                            <option value="{{ receta.id }}">{{ receta.nombre }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="cantidad" class="form-label">Cantidad de Galletas</label>
                        <input type="number" class="form-control" id="cantidad" name="cantidad" min="1" required>
                    </div>
                </form>

                <div id="previsualizacionContainer" style="display: none;">
                    <hr>
                    <h5><i class="bi bi-eye"></i> Previsualización</h5>
                    <div id="previsualizacionContent" class="mt-3"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle"></i> Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="iniciarProduccion()" id="btnIniciarReceta"
                    disabled>
                    <i class="bi bi-play"></i> Iniciar Producción
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    // Función para previsualizar la producción
    function previsualizarProduccion() {
        const recetaId = document.getElementById('receta_id').value;
        const cantidad = document.getElementById('cantidad').value;
        const btnIniciarReceta = document.getElementById('btnIniciarReceta');
        const previsualizacionContainer = document.getElementById('previsualizacionContainer');
        const previsualizacionContent = document.getElementById('previsualizacionContent');

        if (!recetaId || !cantidad) {
            previsualizacionContainer.style.display = 'none';
            btnIniciarReceta.disabled = true;
            return;
        }

        fetch(`/produccion/previsualizarProduccion/${recetaId}/${cantidad}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let html = `
                        <div class="alert ${data.hay_suficientes_insumos ? 'alert-success' : 'alert-warning'}">
                            <h6 class="mb-2"><i class="bi bi-info-circle"></i> Información de Producción</h6>
                            <p class="mb-1"><strong>Receta:</strong> ${data.receta.nombre}</p>
                            <p class="mb-1"><strong>Cantidad solicitada:</strong> ${data.cantidad_solicitada} galletas</p>
                            <p class="mb-1"><strong>Cantidad ajustada:</strong> ${data.cantidad_ajustada} galletas</p>
                            <p class="mb-1"><strong>Estado:</strong> ${data.hay_suficientes_insumos ? 'Hay suficientes insumos' : 'Faltan insumos'}</p>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Insumo</th>
                                        <th>Necesario</th>
                                        <th>Disponible</th>
                                        <th>Estado</th>
                                    </tr>
                                </thead>
                                <tbody>`;

                    data.insumos.forEach(insumo => {
                        html += `
                            <tr>
                                <td>${insumo.nombre}</td>
                                <td>${insumo.cantidad_necesaria} ${insumo.unidad}</td>
                                <td>${insumo.cantidad_disponible} ${insumo.unidad}</td>
                                <td>
                                    <span class="badge ${insumo.hay_suficientes ? 'bg-success' : 'bg-danger'}">
                                        ${insumo.hay_suficientes ? '✓ OK' : '✗ Insuficiente'}
                                    </span>
                                </td>
                            </tr>`;
                    });

                    html += `
                                </tbody>
                            </table>
                        </div>`;

                    // Agregar mensaje de resumen
                    if (data.hay_suficientes_insumos) {
                        html += `
                            <div class="alert alert-success mt-3">
                                <i class="bi bi-check-circle"></i> Todos los insumos están disponibles para la producción.
                            </div>`;
                    } else {
                        const insumosFaltantes = data.insumos.filter(i => !i.hay_suficientes);
                        html += `
                            <div class="alert alert-danger mt-3">
                                <i class="bi bi-exclamation-triangle"></i> Faltan los siguientes insumos:
                                <ul class="mb-0 mt-2">
                                    ${insumosFaltantes.map(i => `
                                        <li>${i.nombre}: Necesario ${i.cantidad_necesaria} ${i.unidad}, Disponible ${i.cantidad_disponible} ${i.unidad}</li>
                                    `).join('')}
                                </ul>
                            </div>`;
                    }

                    previsualizacionContent.innerHTML = html;
                    previsualizacionContainer.style.display = 'block';
                    btnIniciarReceta.disabled = !data.hay_suficientes_insumos;
                } else {
                    previsualizacionContent.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle"></i> Error al previsualizar la producción
                        </div>`;
                    previsualizacionContainer.style.display = 'block';
                    btnIniciarReceta.disabled = true;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                previsualizacionContent.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i> Error al previsualizar la producción
                    </div>`;
                previsualizacionContainer.style.display = 'block';
                btnIniciarReceta.disabled = true;
            });
    }

    // Inicializar la variable recetas con los datos disponibles
    const recetas = [
        {% for receta in recetas %}
        {
            id: {{ receta.id }},
            nombre: "{{ receta.nombre }}",
            galletas_por_lote: {{ receta.galletas_por_lote }},
            gramaje_por_galleta: {{ receta.gramaje_por_galleta }},
            precio_venta: {{ receta.precio_venta }}
        }{% if not loop.last %},{% endif %}
        {% endfor %}
    ];

    // Agregar los event listeners después de que el DOM esté cargado
    document.addEventListener('DOMContentLoaded', function() {
        const recetaSelect = document.getElementById('receta_id');
        const cantidadInput = document.getElementById('cantidad');
        
        if (recetaSelect) {
            recetaSelect.addEventListener('change', function() {
                // Obtener la receta seleccionada
                const recetaId = parseInt(this.value);
                const recetaSeleccionada = recetas.find(r => r.id === recetaId);
                
                // Actualizar la cantidad si se encontró la receta
                if (recetaSeleccionada && recetaSeleccionada.galletas_por_lote) {
                    cantidadInput.value = recetaSeleccionada.galletas_por_lote;
                }
                
                // Llamar a la función de previsualización
                previsualizarProduccion();
            });
        }
        
        if (cantidadInput) {
            cantidadInput.addEventListener('change', previsualizarProduccion);
        }
    });

    function abrirModalIniciarReceta(recetaId, recetaNombre) {
        // Seleccionar la receta en el modal
        const selectReceta = document.getElementById('receta_id');
        if (selectReceta) {
            selectReceta.value = recetaId;
        }

        // Precargar la cantidad de galletas por lote
        const inputCantidad = document.getElementById('cantidad');
        if (inputCantidad) {
            // Buscar la receta seleccionada en el array de recetas
            const recetaSeleccionada = recetas.find(r => r.id === recetaId);
            if (recetaSeleccionada && recetaSeleccionada.galletas_por_lote) {
                inputCantidad.value = recetaSeleccionada.galletas_por_lote;
            }
        }

        // Mostrar el modal
        const modalIniciarReceta = new bootstrap.Modal(document.getElementById('modalIniciarReceta'));
        modalIniciarReceta.show();

        // Actualizar la previsualización después de un breve retraso
        setTimeout(() => {
            // Verificar que el valor de cantidad no se haya perdido
            const inputCantidad = document.getElementById('cantidad');
            const recetaSeleccionada = recetas.find(r => r.id === recetaId);

            if (inputCantidad && recetaSeleccionada && recetaSeleccionada.galletas_por_lote) {
                // Si el valor se perdió, restaurarlo
                if (!inputCantidad.value || inputCantidad.value === '') {
                    inputCantidad.value = recetaSeleccionada.galletas_por_lote;
                }
            }

            // Llamar a la función de previsualización
            previsualizarProduccion();
        }, 500);
    }

    async function confirmarCancelacion(pedidoId) {
        try {
            const result = await Swal.fire({
                title: '¿Estás seguro?',
                text: "¿Deseas cancelar este pedido?",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Sí, cancelar',
                cancelButtonText: 'No, mantener'
            });

            if (result.isConfirmed) {
                // Mostrar indicador de carga
                Swal.fire({
                    title: 'Procesando...',
                    text: 'Por favor espere',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });

                const response = await fetch(`/produccion/cancelar_pedido/${pedidoId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Error al cancelar el pedido');
                }

                // Mostrar mensaje de éxito
                await Swal.fire({
                    title: '¡Éxito!',
                    text: data.message,
                    icon: 'success'
                });

                // Recargar la página
                location.reload();
            }
        } catch (error) {
            console.error('Error:', error);
            await Swal.fire({
                title: 'Error',
                text: error.message || 'Ocurrió un error al cancelar el pedido',
                icon: 'error'
            });
        }
    }

    function producirLote(recetaId, pedidoId, galletasPorLote) {
        // Verificar que tenemos los datos necesarios
        if (!recetaId || !pedidoId || !galletasPorLote) {
            Swal.fire({
                title: 'Error',
                text: 'Datos incompletos para producir el lote',
                icon: 'error'
            });
            return;
        }

        Swal.fire({
            title: '¿Producir lote?',
            text: `Se producirán ${galletasPorLote} galletas (1 lote)`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, producir',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                const formData = new FormData();
                formData.append('receta_id', recetaId);
                formData.append('pedido_id', pedidoId);
                formData.append('cantidad', galletasPorLote);

                // Mostrar indicador de carga
                Swal.fire({
                    title: 'Procesando producción',
                    text: 'Por favor espere...',
                    allowOutsideClick: false,
                    didOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Enviar la solicitud
                fetch('/produccion/producir', {
                    method: 'POST',
                    body: formData
                })
                    .then(response => {
                        return response.json().then(data => {
                            if (!response.ok) {
                                throw new Error(data.error || 'Error al procesar la producción');
                            }
                            return data;
                        });
                    })
                    .then(data => {
                        Swal.fire({
                            title: '¡Éxito!',
                            text: data.message,
                            icon: 'success'
                        }).then(() => {
                            window.location.reload();
                        });
                    })
                    .catch(error => {
                        Swal.fire({
                            title: 'Error',
                            text: error.message || 'Ocurrió un error al procesar la solicitud',
                            icon: 'error'
                        });
                    });
            }
        });
    }

    function solicitarInsumosFaltantes(recetaId, pedidoId) {
        // Obtener información de insumos faltantes
        fetch(`/produccion/insumos_faltantes/${recetaId}/${pedidoId}`)
            .then(response => response.json())
            .then(data => {
                // Mostrar lista de insumos faltantes
                const listaInsumos = document.getElementById('insumosFaltantesLista');
                listaInsumos.innerHTML = '';

                data.insumos_faltantes.forEach(insumo => {
                    const item = document.createElement('div');
                    item.className = 'alert alert-warning';
                    item.setAttribute('role', 'listitem');
                    item.innerHTML = `
                        <strong>${insumo.nombre}</strong><br>
                        Cantidad necesaria: ${insumo.cantidad_necesaria} ${insumo.unidad}<br>
                        Cantidad disponible: ${insumo.cantidad_disponible} ${insumo.unidad}
                    `;
                    listaInsumos.appendChild(item);
                });

                // Configurar botón para solicitar insumos
                const btnSolicitar = document.getElementById('btnSolicitarInsumos');
                btnSolicitar.onclick = function () {
                    solicitarInsumos(recetaId, pedidoId, data.insumos_faltantes);
                };

                // Mostrar modal
                const modalElement = document.getElementById('modalSolicitarInsumos');
                const modal = new bootstrap.Modal(modalElement);

                // Manejar el foco cuando se muestra el modal
                modalElement.addEventListener('shown.bs.modal', function () {
                    const closeButton = modalElement.querySelector('.btn-close');
                    if (closeButton) {
                        closeButton.focus();
                    }
                });

                // Manejar el foco cuando se oculta el modal
                modalElement.addEventListener('hidden.bs.modal', function () {
                    // Devolver el foco al botón que abrió el modal
                    const triggerButton = document.querySelector(`[onclick*="solicitarInsumosFaltantes(${recetaId}, ${pedidoId})"]`);
                    if (triggerButton) {
                        triggerButton.focus();
                    }
                });

                modal.show();
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: 'Ocurrió un error al obtener los insumos faltantes',
                    icon: 'error'
                });
            });
    }

    function solicitarInsumos(recetaId, pedidoId, insumosFaltantes) {
        if (!recetaId || !pedidoId || !insumosFaltantes || insumosFaltantes.length === 0) {
            Swal.fire({
                title: 'Error',
                text: 'No hay insumos para solicitar',
                icon: 'error'
            });
            return;
        }

        // Mostrar indicador de carga
        Swal.fire({
            title: 'Procesando solicitud',
            text: 'Por favor espere...',
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });

        // Crear objeto de datos para enviar
        const formData = new FormData();
        formData.append('receta_id', recetaId);
        formData.append('pedido_id', pedidoId);

        // Agregar cada insumo faltante al formulario
        insumosFaltantes.forEach((insumo, index) => {
            formData.append(`insumo_id_${index}`, insumo.id);
            formData.append(`cantidad_${index}`, insumo.cantidad_necesaria);
        });

        // Enviar la solicitud
        fetch('/produccion/solicitar_insumos', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        })
            .then(response => {
                // Verificar si la respuesta es JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    throw new Error('La respuesta del servidor no es JSON válido');
                }
            })
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }

                Swal.fire({
                    title: '¡Éxito!',
                    text: data.message,
                    icon: 'success'
                }).then(() => {
                    location.reload();
                });
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Ocurrió un error al procesar la solicitud',
                    icon: 'error'
                });
            });
    }

    // Función para verificar insumos
    async function verificarInsumos(recetaId, cantidad) {
        try {
            const response = await fetch('/produccion/verificar_insumos_receta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                },
                body: JSON.stringify({
                    receta_id: recetaId,
                    cantidad: cantidad
                })
            });

            const data = await response.json();

            // Imprimir en consola los datos recibidos
            console.log('=== Datos recibidos del backend ===');
            console.log('Insumos disponibles:', data.insumos_disponibles);
            console.log('Insumos necesarios:', data.insumos_necesarios);
            console.log('Cantidad de galletas:', data.cantidad_galletas);
            console.log('Receta:', data.receta);
            console.log('==================================');

            return data;
        } catch (error) {
            console.error('Error al verificar insumos:', error);
            throw error;
        }
    }

    function atenderPedido(pedidoId) {
        // Obtener el ID de la receta del pedido
        const recetaId = document.querySelector(`[data-pedido-id="${pedidoId}"]`).dataset.recetaId;

        // Primero verificar si se puede atender
        fetch(`/produccion/verificar_receta/${recetaId}`)
            .then(response => response.json())
            .then(data => {
                console.log('Respuesta de verificación:', data); // Para debug

                if (data.success) {
                    // Mostrar modal para ingresar merma
                    Swal.fire({
                        title: 'Registrar Producción',
                        html: `
                            <div class="mb-3">
                                <label for="merma" class="form-label">Cantidad de Merma</label>
                                <input type="number" class="form-control" id="merma" min="0" value="0">
                            </div>
                            <div class="mb-3">
                                <label for="motivo_merma" class="form-label">Motivo de la Merma</label>
                                <textarea class="form-control" id="motivo_merma" rows="2"></textarea>
                            </div>
                        `,
                        showCancelButton: true,
                        confirmButtonText: 'Confirmar',
                        cancelButtonText: 'Cancelar',
                        preConfirm: () => {
                            return {
                                merma: document.getElementById('merma').value,
                                motivo_merma: document.getElementById('motivo_merma').value
                            }
                        }
                    }).then((result) => {
                        if (result.isConfirmed) {
                            const formData = new FormData();
                            formData.append('pedido_id', pedidoId);
                            formData.append('accion', 'atender');
                            formData.append('merma', result.value.merma);
                            formData.append('motivo_merma', result.value.motivo_merma);

                            fetch('/inventario/atender', {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'X-CSRFToken': '{{ csrf_token() }}'
                                }
                            })
                                .then(response => response.json())
                                .then(data => {
                                    if (data.success) {
                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Éxito',
                                            text: data.message,
                                            confirmButtonText: 'Aceptar'
                                        }).then(() => {
                                            location.reload();
                                        });
                                    } else {
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Error',
                                            text: data.message
                                        });
                                    }
                                })
                                .catch(error => {
                                    console.error('Error:', error);
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: 'Ocurrió un error al procesar el pedido'
                                    });
                                });
                        }
                    });
                } else {
                    let mensaje = 'No hay suficientes insumos para atender este pedido.';
                    if (data.insumos_faltantes && data.insumos_faltantes.length > 0) {
                        mensaje += '\nInsumos faltantes:';
                        data.insumos_faltantes.forEach(insumo => {
                            mensaje += `\n- ${insumo.nombre}: ${insumo.cantidad_faltante} ${insumo.unidad}`;
                        });
                    }
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: mensaje
                    });
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Ocurrió un error al verificar los insumos'
                });
            });
    }

    function actualizarEstado(pedidoId, nuevoEstado) {
        const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

        // Si el nuevo estado es completado (4), mostrar modal de merma
        if (nuevoEstado === 4) {
            Swal.fire({
                title: 'Registrar Merma',
                html: `
                    <div class="mb-3">
                        <label for="merma" class="form-label">Cantidad de Merma</label>
                        <input type="number" class="form-control" id="merma" min="0" value="0">
                    </div>
                    <div class="mb-3">
                        <label for="motivo_merma" class="form-label">Motivo de la Merma</label>
                        <textarea class="form-control" id="motivo_merma" rows="2"></textarea>
                    </div>
                `,
                showCancelButton: true,
                confirmButtonText: 'Confirmar',
                cancelButtonText: 'Cancelar',
                preConfirm: () => {
                    return {
                        merma: document.getElementById('merma').value,
                        motivo_merma: document.getElementById('motivo_merma').value
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    // Mostrar indicador de carga
                    Swal.fire({
                        title: 'Procesando...',
                        text: 'Por favor espere',
                        allowOutsideClick: false,
                        showConfirmButton: false,
                        willOpen: () => {
                            Swal.showLoading();
                        }
                    });

                    // Crear FormData con todos los datos necesarios
                    const formData = new FormData();
                    formData.append('estado_pedido_id', nuevoEstado);
                    formData.append('merma', result.value.merma);
                    formData.append('motivo_merma', result.value.motivo_merma);

                    // Enviar la solicitud
                    fetch(`/produccion/actualizar_estado/${pedidoId}`, {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'X-CSRFToken': csrfToken
                        }
                    })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                Swal.fire({
                                    title: '¡Éxito!',
                                    text: data.message,
                                    icon: 'success'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                throw new Error(data.message);
                            }
                        })
                        .catch(error => {
                            Swal.fire({
                                title: 'Error',
                                text: error.message || 'Ocurrió un error al actualizar el estado',
                                icon: 'error'
                            });
                        });
                }
            });
        } else {
            // Para otros estados, proceder normalmente
            const formData = new FormData();
            formData.append('estado_pedido_id', nuevoEstado);

            // Mostrar indicador de carga
            Swal.fire({
                title: 'Procesando...',
                text: 'Por favor espere',
                allowOutsideClick: false,
                showConfirmButton: false,
                willOpen: () => {
                    Swal.showLoading();
                }
            });

            fetch(`/produccion/actualizar_estado/${pedidoId}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire({
                            title: '¡Éxito!',
                            text: data.message,
                            icon: 'success'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        throw new Error(data.message);
                    }
                })
                .catch(error => {
                    Swal.fire({
                        title: 'Error',
                        text: error.message || 'Ocurrió un error al actualizar el estado',
                        icon: 'error'
                    });
                });
        }
    }

    // Función para iniciar la producción
    function iniciarProduccion() {
        const recetaId = document.getElementById('receta_id').value;
        const cantidad = document.getElementById('cantidad').value;
        
        // Mostrar indicador de carga
        Swal.fire({
            title: 'Procesando...',
            text: 'Por favor espere',
            allowOutsideClick: false,
            showConfirmButton: false,
            willOpen: () => {
                Swal.showLoading();
            }
        });
        
        // Obtener los datos de previsualización
        fetch(`/produccion/previsualizarProduccion/${recetaId}/${cantidad}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Error al iniciar la producción');
                }
                
                // Enviar la solicitud para iniciar la producción
                return fetch(`/produccion/empezar_produccion/${recetaId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
                    }
                });
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error HTTP: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Cerrar el modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalIniciarReceta'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Mostrar mensaje de éxito
                    Swal.fire({
                        icon: 'success',
                        title: '¡Éxito!',
                        text: data.message || 'Producción iniciada correctamente',
                        confirmButtonText: 'Aceptar'
                    }).then(() => {
                        // Recargar la página para actualizar los datos
                        window.location.reload();
                    });
                } else {
                    throw new Error(data.message || 'Error al iniciar la producción');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Ocurrió un error al iniciar la producción'
                });
            });
    }

    function iniciarRecetaManual() {
        const recetaId = document.getElementById('receta_id').value;
        const cantidad = document.getElementById('cantidad').value;

        if (!recetaId || !cantidad) {
            Swal.fire({
                title: 'Error',
                text: 'Por favor seleccione una receta y especifique la cantidad',
                icon: 'error'
            });
            return;
        }

        // Primero obtener la previsualización para verificar insumos
        fetch(`/produccion/previsualizarProduccion/${recetaId}/${cantidad}`)
            .then(response => {
                // Verificar si la respuesta es JSON
                const contentType = response.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    return response.json();
                } else {
                    throw new Error('La respuesta del servidor no es JSON válido');
                }
            })
            .then(data => {
                if (!data.success) {
                    throw new Error(data.message || 'Error al previsualizar la producción');
                }

                // Verificar si hay suficientes insumos
                if (!data.hay_suficientes_insumos) {
                    Swal.fire({
                        title: 'Error',
                        text: 'No hay suficientes insumos para producir esta cantidad de galletas',
                        icon: 'error'
                    });
                    return;
                }

                // Confirmar antes de iniciar
                return Swal.fire({
                    title: '¿Iniciar producción?',
                    text: `Se iniciará la producción de ${data.cantidad_ajustada} galletas con la receta ${data.receta.nombre}`,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'Sí, iniciar',
                    cancelButtonText: 'Cancelar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        return data; // Devolver los datos de previsualización
                    } else {
                        throw new Error('Operación cancelada por el usuario');
                    }
                });
            })
            .then(data => {
                // Mostrar indicador de carga
                Swal.fire({
                    title: 'Procesando...',
                    text: 'Por favor espere',
                    allowOutsideClick: false,
                    showConfirmButton: false,
                    willOpen: () => {
                        Swal.showLoading();
                    }
                });

                // Preparar los datos para enviar
                const requestData = {
                    receta_id: data.receta.id,
                    cantidad: data.cantidad_solicitada,
                    insumos: data.insumos.map(insumo => {
                        const lotesInfo = insumo.lotes_info;
                        const lotesSeleccionados = [];

                        if (lotesInfo && lotesInfo !== 'Sin lotes disponibles') {
                            const lotes = lotesInfo.split(', ');
                            let cantidadRestante = insumo.cantidad_necesaria;

                            lotes.forEach(loteInfo => {
                                const match = loteInfo.match(/L(\d+)\((\d+)\)/);
                                if (match) {
                                    const loteId = `L${match[1]}`;
                                    const cantidadDisponible = parseInt(match[2]);

                                    if (cantidadRestante > 0) {
                                        const cantidadAUsar = Math.min(cantidadDisponible, cantidadRestante);
                                        lotesSeleccionados.push({
                                            lote_id: loteId,
                                            cantidad_a_usar: cantidadAUsar
                                        });
                                        cantidadRestante -= cantidadAUsar;
                                    }
                                }
                            });
                        }

                        return {
                            nombre: insumo.nombre,
                            cantidad_necesaria: insumo.cantidad_necesaria,
                            lotes_seleccionados: lotesSeleccionados
                        };
                    })
                };

                // Obtener el token CSRF
                const csrfToken = document.querySelector('meta[name="csrf-token"]').content;

                // Enviar la solicitud a /produccion/empezar_receta
                return fetch('/produccion/empezar_receta', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    },
                    body: JSON.stringify(requestData)
                }).then(response => {
                    // Verificar si la respuesta es JSON
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        return response.json();
                    } else {
                        throw new Error('La respuesta del servidor no es JSON válido');
                    }
                });
            })
            .then(data => {
                if (data.success) {
                    Swal.fire({
                        title: '¡Éxito!',
                        text: `Producción iniciada correctamente. Pedido ID: ${data.pedido_id}`,
                        icon: 'success'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    throw new Error(data.message || 'Error al iniciar la producción');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Ocurrió un error al iniciar la producción',
                    icon: 'error'
                });
            });
    }
</script>
{% endblock %}